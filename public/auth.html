<!doctype html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SnapNotes • Auth</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full bg-gray-50 text-gray-900 antialiased dark:bg-gray-950 dark:text-gray-100">
<header id="app-header" class="sticky top-0 z-40 border-b border-gray-200 bg-white/80 backdrop-blur dark:border-gray-800 dark:bg-gray-900/80"></header>

<main class="mx-auto max-w-7xl px-4 py-8 grid gap-6 md:grid-cols-3">
  <!-- Sign up -->
  <section class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
    <h2 class="mb-3 text-base font-semibold">Sign up</h2>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Username</label>
    <input id="su_username" class="mb-2 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Email</label>
    <input id="su_email" class="mb-2 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Password</label>
    <input id="su_password" type="password" class="mb-4 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <button id="signupBtn" class="w-full rounded-xl bg-indigo-600 px-4 py-2 text-white">Sign up</button>
    <p class="mt-2 text-xs text-gray-500">If emails are throttled, an admin can confirm you via CLI.</p>
  </section>

  <!-- Confirm -->
  <section class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
    <h2 class="mb-3 text-base font-semibold">Confirm sign up</h2>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Username</label>
    <input id="cf_username" class="mb-2 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Confirmation code</label>
    <input id="cf_code" class="mb-4 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <button id="confirmBtn" class="w-full rounded-xl bg-indigo-600 px-4 py-2 text-white">Confirm</button>
  </section>

  <!-- Login -->
  <section class="rounded-2xl border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800">
    <h2 class="mb-3 text-base font-semibold">Login</h2>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Username</label>
    <input id="li_username" class="mb-2 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <label class="text-xs font-medium text-gray-600 dark:text-gray-300">Password</label>
    <input id="li_password" type="password" class="mb-4 w-full rounded-xl border px-3 py-2 dark:bg-gray-800"/>
    <button id="loginBtn" class="w-full rounded-xl bg-indigo-600 px-4 py-2 text-white">Login</button>
    <p class="mt-2 text-xs text-gray-500">Token use: <code>access</code>. Pool/client must match the server env.</p>
  </section>
</main>

<script src="/public/shared.js"></script>
<script>
  App.renderHeader('auth');

  // If already logged in, skip straight to Upload
  if (App.getToken()) {
    location.replace('/public/upload.html');
  }

  const $ = s => document.querySelector(s);
  const accessTokenFrom = (r) =>
          r?.tokens?.AccessToken ||
          r?.accessToken ||
          r?.AccessToken ||
          r?.AuthenticationResult?.AccessToken || null;

  // Sign up
  $('#signupBtn').onclick = async () => {
    const username = $('#su_username').value.trim();
    const email    = $('#su_email').value.trim();
    const password = $('#su_password').value;
    if (!username || !email || !password) return App.toast('Fill all fields');
    try {
      await App.api('/auth/signup', {
        method:'POST',
        body: JSON.stringify({ username, email, password }),
        auth:false
      });
      App.toast('Signup submitted', true);
      $('#cf_username').value = username;
    } catch(e){ App.toast('Signup error: ' + e.message); }
  };

  // Confirm
  $('#confirmBtn').onclick = async () => {
    const username = $('#cf_username').value.trim();
    const code     = $('#cf_code').value.trim();
    if (!username || !code) return App.toast('Fill username & code');
    try {
      await App.api('/auth/confirm', {
        method:'POST',
        body: JSON.stringify({ username, code }),
        auth:false
      });
      App.toast('Confirmed. You can log in now.', true);
      $('#li_username').value = username;
    } catch(e){ App.toast('Confirm error: ' + e.message); }
  };

  // Login → store AccessToken → redirect to Upload
  $('#loginBtn').onclick = async () => {
    const username = $('#li_username').value.trim();
    const password = $('#li_password').value;
    if (!username || !password) return App.toast('Fill username & password');

    try {
      const r = await App.api('/auth/login', {
        method:'POST',
        body: JSON.stringify({ username, password }),
        auth:false
      });

      const t = accessTokenFrom(r);
      if (!t) throw new Error('No AccessToken in response');

      App.setToken(t);
      App.toast('Logged in', true);

      // Hard redirect (no back to login)
      location.replace('/public/upload.html');
    } catch(e){ App.toast('Login error: ' + e.message); }
  };
</script>
</body>
</html>
